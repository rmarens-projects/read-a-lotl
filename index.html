<!DOCTYPE html>
<html>
<head>
  <title>Speech-to-Text</title>
  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
  <style>
    body { font-family: Fredoka; padding: 20px; }
    #result { margin-top: 20px; font-size: 1.2em; }
    div { max-width: 180px; }
    button {background-color: none; border: 0; border-radius: 24px; color: none; padding: 4px; margin-right:4px; text-align: center; text-decoration: none; display: inline-block; font-size: 1px;}  
  </style>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap" rel="stylesheet">
</head>
<body>
<div>
    <button id="startBtn"><img src="btn/btn_Record_green.png" width="64" height="64"></button>
  <button id="stopBtn" disabled><img src="btn/btn_Stop.png" width="64" height="64"></button>

  <p id="result"></p>
</div>
  <script>
    let recognizer;
    let SpeechSDK;

    document.addEventListener("DOMContentLoaded", function () {
          // Make sure Storyline's player is accessible
        let storylinePlayer = null;
        try {
            storylinePlayer = window.parent.storylinePlayer || null;
        } catch (e) {
            console.log("Storyline player not available.");
        }
      
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const resultBox = document.getElementById("result");

      // Load Speech SDK
      if (window.SpeechSDK) {
        SpeechSDK = window.SpeechSDK;
      } else {
        console.error("Speech SDK not loaded.");
        return;
      }

      startBtn.onclick = function () {
        resultBox.innerText = ""; // Clear previous result
        
        startBtn.disabled = true;
        stopBtn.disabled = false;

        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription("825wruwAIMD2jKErKW8HXmBJYBJfxHcyuFiPAuMyD1CVeRpZ9rueJQQJ99BDACYeBjFXJ3w3AAAYACOGVaCL", "eastus");
        speechConfig.speechRecognitionLanguage = "en-US";
        speechConfig.setProperty("SPEECH-START-SILENCE-TIMEOUT", "10000");
        speechConfig.setProperty("SPEECH-END-SILENCE-TIMEOUT", "10000");

        const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();

        recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

        recognizer.recognized = function (s, e) {
  if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech && e.result.text) {
    // Add a space if the last character in the box isn't already a space
    const currentText = resultBox.innerText.trim();
    const needsSpace = currentText && !/[.?!]\s$/.test(currentText);

    resultBox.innerText = currentText + (needsSpace ? " " : " ") + e.result.text;
  } else if (e.result.reason === SpeechSDK.ResultReason.NoMatch) {
    resultBox.innerText += "\nNo speech recognized.\n";
  }
};



        recognizer.startContinuousRecognitionAsync();
      };

      stopBtn.onclick = function () {
    stopBtn.disabled = true;
    startBtn.disabled = false;

    if (recognizer) {
        recognizer.stopContinuousRecognitionAsync(
            () => {
                recognizer.close();

                // Get the transcript text from the resultBox
                const transcriptText = document.getElementById("resultBox").innerText.trim();

                // Remove all special characters (keeping only letters and spaces)
                const cleanText = transcriptText.replace(/[^a-zA-Z\s]/g, "");

                // Send the cleaned transcript to Storyline
                if (window.parent.storylinePlayer) {
                    const storylinePlayer = window.parent.storylinePlayer;
                    storylinePlayer.SetVar("TranscriptText", cleanText);
                    console.log("Cleaned transcript sent to Storyline:", cleanText);
                }
            },
            err => console.error(err)
        );
    }
};

    });
  </script>

</body>
</html>
